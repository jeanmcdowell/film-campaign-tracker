<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Film Marketing & Distribution Pipeline</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore-compat.js"></script>
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  html, body, #root { height: 100%; width: 100%; overflow: hidden; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; color: #1a1a2e; background: #f5f5f7; }
  button, input, select, textarea { font-family: inherit; }
  ::-webkit-scrollbar { width: 5px; height: 5px; }
  ::-webkit-scrollbar-track { background: transparent; }
  ::-webkit-scrollbar-thumb { background: #c4c4c4; border-radius: 3px; }
  input[type="date"] { padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; }
  select { padding: 4px 6px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; background: #fff; }
  textarea { padding: 6px 8px; border: 1px solid #d1d5db; border-radius: 4px; font-size: 12px; resize: vertical; }

  @media print {
    body { background: #fff !important; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
    .no-print { display: none !important; }
    .print-only { display: block !important; }
    .print-break { page-break-before: always; }
    #root > div { display: block !important; height: auto !important; overflow: visible !important; }
    .sidebar-container { display: none !important; }
    .main-scroll { overflow: visible !important; height: auto !important; }
    .gantt-scroll { overflow: visible !important; }
    .print-header { display: flex !important; align-items: center; gap: 16px; padding: 24px 0; border-bottom: 3px solid #1a1a2e; margin-bottom: 24px; }
    .print-header h1 { font-size: 28px; }
    .print-header p { color: #666; font-size: 14px; }
  }
</style>
</head>
<body>
<div id="root"></div>
<script>
firebase.initializeApp({
  apiKey: "AIzaSyBeBSfZD1sqmj9h090IArB71AUrsiPsXSE",
  authDomain: "film-campaign-tracker---jfm.firebaseapp.com",
  projectId: "film-campaign-tracker---jfm",
  storageBucket: "film-campaign-tracker---jfm.firebasestorage.app",
  messagingSenderId: "252133110788",
  appId: "1:252133110788:web:d40696404f7a57e57ab151"
});
const fbAuth = firebase.auth();
const fbDb = firebase.firestore();
</script>
<script type="text/babel">
const { useState, useMemo, useRef, useEffect, useCallback } = React;

/* ── helpers ─────────────────────────────────────────────── */
const fmt = d => { if (!d) return ""; const dt = new Date(d + "T00:00:00"); return dt.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" }); };
const addDays = (d, n) => { const dt = new Date(d + "T00:00:00"); dt.setDate(dt.getDate() + n); return dt.toISOString().slice(0, 10); };
const todayStr = () => new Date().toISOString().slice(0, 10);
const defaultRelease = () => addDays(todayStr(), 90);
const daysBetween = (a, b) => { if (!a || !b) return 0; return Math.round((new Date(b + "T00:00:00") - new Date(a + "T00:00:00")) / 86400000); };
const monthsBetween = (a, b) => { const da = new Date(a + "T00:00:00"), db = new Date(b + "T00:00:00"); return (db.getFullYear() - da.getFullYear()) * 12 + db.getMonth() - da.getMonth() + 1; };
const getMonthStart = d => d.slice(0, 7) + "-01";
const monthLabel = d => { const dt = new Date(d + "T00:00:00"); return dt.toLocaleDateString("en-US", { month: "short", year: "numeric" }); };
const uid = () => Math.random().toString(36).slice(2, 9);
const STATUS_COLORS = { "not-started": "#94a3b8", "in-progress": "#3b82f6", "complete": "#10b981", "blocked": "#ef4444" };
const STATUS_LABELS = { "not-started": "Not Started", "in-progress": "In Progress", "complete": "Complete", "blocked": "Blocked" };

/* ── Campaign Color Palette ──────────────────────────────── */
const CAMPAIGN_COLORS = ["#7c3aed","#b91c1c","#0369a1","#059669","#ea580c","#e11d48","#0ea5e9","#f59e0b","#d946ef","#6366f1","#475569","#0891b2","#16a34a","#c026d3","#dc2626","#2563eb"];

/* ── Task Library (templates to add à la carte) ──────────── */
const TASK_LIBRARY = {
  "Marketing Strategy & Planning": [
    { title: "Initial Filmmaker Meeting", description: "Formal sit-down between the marketing team and the filmmaker (director, producers) to understand the creative vision, intended audience, comparable titles, and any sensitivities.", durationWeeks: 1, roles: ["Head of Marketing", "Campaign Manager", "Director", "Producer"] },
    { title: "Market Positioning & Target Audience Definition", description: "Define competitive positioning, core selling proposition, and emotional hooks. Segment audiences by demographics, psychographics, and media consumption.", durationWeeks: 6, roles: ["Head of Marketing", "Market Research", "Campaign Manager"] },
    { title: "Competitive Release Landscape Analysis", description: "Map competing releases across the calendar: same genre, same demographic, tentpole blockbusters, and counter-programming opportunities.", durationWeeks: 3, roles: ["Campaign Manager", "Distribution", "Market Research"] },
    { title: "Campaign Strategy Deck & Presentation", description: "Compile positioning, audience research, competitive analysis, and recommended marketing approach into a comprehensive strategy deck.", durationWeeks: 3, roles: ["Head of Marketing", "Campaign Manager"] },
    { title: "Ongoing Filmmaker Check-Ins", description: "Regularly scheduled touchpoints with the filmmaker to review creative materials, present research findings, and maintain alignment on tone and messaging.", durationWeeks: 24, roles: ["Head of Marketing", "Campaign Manager", "Director", "Producer"] }
  ],
  "Marketing Budget & Operations": [
    { title: "Preliminary P&A Budget Development", description: "Develop initial print & advertising budget framework based on projected performance, comparable titles, and distribution strategy.", durationWeeks: 4, roles: ["Head of Marketing", "Marketing Finance", "Distribution"] },
    { title: "Budget Finalization & Approval", description: "Lock the final P&A budget after all department inputs, media bids, and creative cost estimates. Secure executive approval.", durationWeeks: 2, roles: ["Head of Marketing", "Marketing Finance", "Studio Executive"] },
    { title: "Monthly Budget Tracking & Variance Reporting", description: "Track actual spend vs. budget across all line items on a weekly/monthly basis. Flag variances and manage reallocation requests.", durationWeeks: 24, roles: ["Marketing Finance", "Campaign Manager"] },
    { title: "Final Budget Reconciliation", description: "Post-release reconciliation of all P&A spending. Close out vendor invoices and produce the final campaign cost report.", durationWeeks: 4, roles: ["Marketing Finance", "Accounting"] },
    { title: "Materials & Asset Management", description: "Centralized tracking and distribution of all creative assets across departments, territories, and partners.", durationWeeks: 20, roles: ["Campaign Manager", "Asset Manager"] }
  ],
  "Creative Advertising: Trailers": [
    { title: "Teaser Trailer Production", description: "Craft the initial teaser trailer (60\u201390 sec) to establish tone, intrigue, and brand identity without revealing major plot points.", durationWeeks: 6, roles: ["Trailer Editor", "Trailer House", "Head of Marketing"] },
    { title: "Theatrical Trailer Production", description: "Produce the primary theatrical trailer (2:00\u20132:30). The single most important marketing asset.", durationWeeks: 8, roles: ["Trailer Editor", "Trailer House", "Head of Marketing", "Director"] },
    { title: "International Trailer Versioning", description: "Adapt the domestic trailer for international markets: alternate footage, re-edited for local ratings boards, textless backgrounds.", durationWeeks: 4, roles: ["Trailer House", "International Marketing"] },
    { title: "Trailer Music Licensing & Composition", description: "License or commission custom music for trailers. Negotiate synchronization rights for pre-existing tracks or hire a trailer music composer.", durationWeeks: 6, roles: ["Music Supervisor", "Trailer House", "Business Affairs"] },
    { title: "Filmmaker Trailer Approval Process", description: "Formal review and approval cycles with the director/producer per contractual creative approval rights.", durationWeeks: 4, roles: ["Head of Marketing", "Director", "Producer"] },
    { title: "Teaser Trailer Debut & Distribution", description: "Plan and execute the public debut of the teaser trailer: exclusive platform premiere, coordinated PR push, social media rollout, paid amplification.", durationWeeks: 2, roles: ["Head of Marketing", "Digital Marketing Manager", "PR Agency", "Social Media Manager"] },
    { title: "Trailer Performance Targets & Analytics", description: "Set and track quantitative targets for each trailer release: 24-hour view count goals, 7-day benchmarks, sentiment analysis.", durationWeeks: 4, roles: ["Digital Marketing Manager", "Market Research", "Campaign Manager"] }
  ],
  "Creative Advertising: TV Spots & Digital": [
    { title: "TV Spot Production: :60 Spots", description: "Produce 60-second TV spots derived from trailer footage for premium placement.", durationWeeks: 3, roles: ["Trailer Editor", "Creative Agency", "Head of Marketing"] },
    { title: "TV Spot Production: :30 Spots", description: "Produce 30-second TV spots \u2014 the workhorse of broadcast advertising. Multiple versions targeting different demographics.", durationWeeks: 3, roles: ["Trailer Editor", "Creative Agency", "Media Planner"] },
    { title: "TV Spot Production: :15 Spots", description: "Produce 15-second TV spots for high-frequency rotation, digital pre-roll, and late-campaign urgency messaging.", durationWeeks: 2, roles: ["Trailer Editor", "Creative Agency"] },
    { title: "Digital-First Video Creative", description: "Produce video assets for digital platforms: 6-second bumpers, vertical video for TikTok/Reels/Shorts, interactive end-cards.", durationWeeks: 4, roles: ["Creative Agency", "Digital Marketing Manager"] },
    { title: "TV & Spot Music Licensing", description: "Secure synchronization and master use licenses for all music used in TV spots and digital video creative.", durationWeeks: 6, roles: ["Music Supervisor", "Business Affairs", "Creative Agency"] },
    { title: "Broadcast Standards & Ratings Clearance", description: "Submit all TV spots to broadcast standards departments and MPAA for ratings band approval.", durationWeeks: 2, roles: ["Campaign Manager", "Creative Agency"] }
  ],
  "Key Art & Visual Identity": [
    { title: "Talent Photo Shoot", description: "Coordinate and execute a dedicated photo shoot with the film's cast for key art, press materials, and marketing assets.", durationWeeks: 2, roles: ["Key Art Designer", "Photographer", "Publicity", "Talent Reps"] },
    { title: "Teaser One-Sheet Design", description: "Design the initial teaser poster that establishes the film's visual marketing identity.", durationWeeks: 4, roles: ["Key Art Designer", "Creative Agency", "Head of Marketing"] },
    { title: "Final One-Sheet (Payoff Poster)", description: "Design the primary theatrical one-sheet: the definitive poster for theaters, online, and all print advertising.", durationWeeks: 6, roles: ["Key Art Designer", "Creative Agency", "Head of Marketing", "Business Affairs"] },
    { title: "Character Posters & Series", description: "Design individual character posters or a themed poster series for ensemble casts.", durationWeeks: 4, roles: ["Key Art Designer", "Creative Agency"] },
    { title: "Outdoor & Transit Creative Adaptation", description: "Adapt key art for large-format outdoor placements: billboards, bus shelters, subway cards, wallscapes.", durationWeeks: 3, roles: ["Key Art Designer", "Creative Agency", "Media Planner"] },
    { title: "Digital Display & Banner Creative", description: "Produce the full suite of digital display ads in all standard IAB sizes plus rich media and animated HTML5 units.", durationWeeks: 3, roles: ["Creative Agency", "Digital Marketing Manager"] }
  ],
  "Research, Tracking & Materials Testing": [
    { title: "Baseline Awareness & Interest Study", description: "Conduct initial quantitative research to establish baseline awareness, unaided recall, and interest levels.", durationWeeks: 3, roles: ["Market Research", "Research Vendor"] },
    { title: "Trailer Testing (Quantitative)", description: "Test trailer(s) with recruited audiences. Measure purchase intent, emotional response, genre appeal.", durationWeeks: 3, roles: ["Market Research", "Research Vendor", "Head of Marketing"] },
    { title: "TV Spot Testing", description: "Test :30 and :60 TV spots for message clarity, persuasion, likability, and purchase intent.", durationWeeks: 2, roles: ["Market Research", "Research Vendor", "Media Planner"] },
    { title: "Key Art / Poster Testing", description: "Test one-sheet concepts with target audiences to evaluate visual appeal and purchase intent.", durationWeeks: 2, roles: ["Market Research", "Research Vendor", "Key Art Designer"] },
    { title: "Ongoing Tracking Studies", description: "Weekly or bi-weekly tracking surveys measuring awareness, first choice, definite interest, and purchase intent.", durationWeeks: 12, roles: ["Market Research", "Research Vendor", "Campaign Manager"] },
    { title: "Competitive Tracking & Share of Voice", description: "Monitor competitors' marketing activity: trailer drops, social media engagement, media spend estimates.", durationWeeks: 12, roles: ["Market Research", "Campaign Manager"] },
    { title: "Test Screening Audience Research", description: "Conduct recruited audience test screenings with detailed exit surveys and focus groups.", durationWeeks: 6, roles: ["Market Research", "Research Vendor", "Producer", "Editor"] },
    { title: "Opening Weekend Exit Polling", description: "Deploy exit surveys at theaters on opening weekend to capture audience demographics and satisfaction scores.", durationWeeks: 1, roles: ["Market Research", "Distribution Analyst"] }
  ],
  "Paid Media & Media Planning": [
    { title: "Media Strategy & Channel Planning", description: "Develop the overarching media strategy: channel mix, flighting schedule, reach/frequency targets, and budget allocation.", durationWeeks: 4, roles: ["Media Planner", "Head of Marketing"] },
    { title: "National TV Buy (Broadcast & Cable)", description: "Negotiate and execute the national television advertising buy across broadcast networks, cable, and connected TV.", durationWeeks: 8, roles: ["Media Buyer", "Media Planner"] },
    { title: "Digital & Programmatic Media Buy", description: "Execute the digital advertising buy across programmatic display, paid search, online video, and connected TV.", durationWeeks: 8, roles: ["Media Buyer", "Digital Marketing Manager"] },
    { title: "Outdoor & Out-of-Home (OOH) Buy", description: "Secure outdoor advertising placements: billboards, bus shelters, transit wraps, subway dominations.", durationWeeks: 6, roles: ["Media Buyer", "Media Planner"] },
    { title: "Cinema Advertising Buy", description: "Book in-theater advertising: pre-show trailer placements, lobby displays, concession promotions.", durationWeeks: 4, roles: ["Media Buyer", "Exhibition Relations"] },
    { title: "Radio Buy & Audio Advertising", description: "Execute radio advertising across terrestrial, satellite, and streaming audio platforms.", durationWeeks: 4, roles: ["Media Buyer", "Creative Agency"] },
    { title: "Paid Social Media Advertising", description: "Execute paid campaigns across Meta, TikTok, X, YouTube, Snapchat, and Reddit.", durationWeeks: 8, roles: ["Digital Marketing Manager", "Media Buyer", "Social Media Manager"] },
    { title: "Final Media Plan Lock & Flowchart", description: "Finalize the comprehensive media plan flowchart showing all placements, flighting dates, budgets.", durationWeeks: 2, roles: ["Media Planner", "Head of Marketing", "Campaign Manager"] },
    { title: "Paid Media Flight Execution & Optimization", description: "Execute the live media flight across all channels. Monitor daily delivery, optimize in real-time.", durationWeeks: 8, roles: ["Media Buyer", "Media Planner", "Digital Marketing Manager"] }
  ],
  "National PR, Publicity & Press": [
    { title: "EPK (Electronic Press Kit) Production", description: "Produce the comprehensive EPK: BTS footage, cast/crew interviews, b-roll packages, hi-res stills, bios.", durationWeeks: 12, roles: ["Unit Publicist", "EPK Producer", "Still Photographer"] },
    { title: "Long-Lead Press Campaign", description: "Place exclusive stories in monthly magazines and feature outlets 3\u20136 months before release.", durationWeeks: 8, roles: ["Publicity Department", "PR Agency"] },
    { title: "Short-Lead Press & Online Blitz", description: "Coordinate the final wave of press coverage 2\u20134 weeks before release.", durationWeeks: 4, roles: ["Publicity Department", "PR Agency"] },
    { title: "Press Junket Planning & Execution", description: "Organize full press junkets: domestic roundtables, international press days, one-on-one interviews.", durationWeeks: 3, roles: ["Publicity Department", "Talent Reps", "PR Agency"] },
    { title: "Premiere Event Planning & Execution", description: "Produce the world premiere: red carpet, press line, screening, and after-party.", durationWeeks: 6, roles: ["Events Team", "PR Agency", "Publicity Department"] },
    { title: "Review Embargo & Critics Screenings", description: "Schedule advance critic screenings and set the review embargo strategy.", durationWeeks: 3, roles: ["Publicity Department", "Distribution"] },
    { title: "Awards Campaign Strategy & Execution", description: "Plan guild screenings, FYC mailings, trade advertising, Q&A events, and voter outreach.", durationWeeks: 16, roles: ["Awards Strategist", "PR Agency", "Publicity"] },
    { title: "Exclusive Clip Releases & EPK Distribution", description: "Strategically release exclusive film clips to targeted media outlets throughout the campaign.", durationWeeks: 6, roles: ["Publicity Department", "PR Agency", "Digital Marketing Manager"] },
    { title: "Press Day Coordination & Execution", description: "Organize a dedicated press day with talent available for back-to-back interviews.", durationWeeks: 2, roles: ["Publicity Department", "PR Agency", "Talent Reps"] }
  ],
  "Regional PR & Field Marketing": [
    { title: "Regional Publicity Plan & Market Selection", description: "Identify priority local markets and develop a market-by-market PR strategy.", durationWeeks: 4, roles: ["Regional PR Coordinator", "Campaign Manager"] },
    { title: "Local Media Outreach & Interviews", description: "Pitch and coordinate local TV, radio, newspaper, and digital outlet coverage in top markets.", durationWeeks: 6, roles: ["Regional PR Coordinator", "Talent Reps"] },
    { title: "Grassroots Screening Program", description: "Organize advance screenings for community groups, cultural organizations, and affinity groups.", durationWeeks: 4, roles: ["Field Marketing Manager", "Regional PR Coordinator"] },
    { title: "Regional Promotional Events", description: "Execute local-market promotional events: pop-ups, mall activations, campus visits.", durationWeeks: 4, roles: ["Field Marketing Manager", "Events Team"] },
    { title: "Satellite Media Tour (SMT)", description: "Produce a satellite media tour where talent conducts back-to-back live interviews with local TV stations.", durationWeeks: 1, roles: ["Regional PR Coordinator", "PR Agency", "Talent Reps"] }
  ],
  "Digital & Social Media": [
    { title: "Launch Official Social Media Profiles", description: "Create and launch the film's official accounts across all relevant platforms.", durationWeeks: 2, roles: ["Social Media Manager", "Creative Agency"] },
    { title: "Social Media Content Calendar & Organic Campaign", description: "Develop and execute a multi-month content calendar with reveals, BTS, cast takeovers, and engagement prompts.", durationWeeks: 24, roles: ["Social Media Manager", "Content Creator"] },
    { title: "Official Film Website Build & Launch", description: "Design and develop the dedicated film website with trailer embed, ticketing integration, and SEO optimization.", durationWeeks: 6, roles: ["Web Developer", "Digital Marketing Manager", "Creative Agency"] },
    { title: "Update Corporate / Studio Website", description: "Update the production company or studio's corporate website with the new film.", durationWeeks: 1, roles: ["Web Developer", "Digital Marketing Manager"] },
    { title: "Influencer & Creator Partnerships", description: "Identify and partner with influencers whose audiences align with the film's demo.", durationWeeks: 6, roles: ["Digital Marketing Manager", "Influencer Agency"] },
    { title: "Email Marketing & CRM Sequences", description: "Build email lists and produce sequences: awareness, trailer drop, ticket pre-sale, opening weekend urgency.", durationWeeks: 8, roles: ["Email Marketing Specialist", "Digital Marketing Manager"] },
    { title: "Social Activations & Tentpole Moments", description: "Plan and execute high-impact social media activations tied to key campaign moments.", durationWeeks: 12, roles: ["Social Media Manager", "Content Creator", "Digital Marketing Manager"] },
    { title: "Official Website Launch & Ticketing Integration", description: "Coordinate the public launch of the film's official website timed to a major campaign beat.", durationWeeks: 2, roles: ["Web Developer", "Digital Marketing Manager", "Campaign Manager"] }
  ],
  "Promotional Partnerships, Stunts & Activations": [
    { title: "Brand Partnership Development", description: "Identify and negotiate cross-promotional deals with consumer brands.", durationWeeks: 12, roles: ["Promotions Department", "Brand Partners", "Licensing"] },
    { title: "Experiential Activations & Immersive Events", description: "Design and produce large-scale experiential marketing activations and themed environments.", durationWeeks: 8, roles: ["Experiential Agency", "Events Team", "Creative Agency"] },
    { title: "Publicity Stunts & Guerrilla Marketing", description: "Conceive and execute attention-grabbing publicity stunts for earned media and social virality.", durationWeeks: 4, roles: ["PR Agency", "Events Team", "Experiential Agency"] },
    { title: "Promotional Merchandise & Giveaways", description: "Design and produce promotional merchandise: branded swag, press kits, fan giveaways.", durationWeeks: 6, roles: ["Promotions Department", "Licensing", "Creative Agency"] },
    { title: "Convention & Industry Event Presence", description: "Plan the film's presence at key industry events: CinemaCon, Comic-Con, SXSW.", durationWeeks: 4, roles: ["Campaign Manager", "Publicity", "Events Team"] },
    { title: "Retail & In-Store Partnerships", description: "Negotiate retail partnerships for in-store displays, endcap takeovers, co-branded packaging.", durationWeeks: 8, roles: ["Promotions Department", "Retail Partners", "Home Entertainment"] }
  ],
  "Festival Strategy": [
    { title: "Festival Selection & Submission", description: "Determine optimal festival fit by genre, prestige, market timing, and distribution strategy.", durationWeeks: 8, roles: ["Festival Strategist", "Producer"] },
    { title: "Festival Premiere Logistics & Execution", description: "Coordinate DCP delivery, technical checks, talent travel, press day scheduling, party planning.", durationWeeks: 6, roles: ["Festival Strategist", "Producer", "Publicity"] },
    { title: "Market Screenings & Buyer Meetings", description: "Organize market screenings and schedule meetings with territory distributors at festival markets.", durationWeeks: 2, roles: ["Sales Agent", "Producer"] },
    { title: "Festival Press & Social Coverage", description: "Manage press coverage during the festival: red carpet, press conference, live social coverage.", durationWeeks: 2, roles: ["Publicity Department", "Social Media Manager"] }
  ],
  "Sales & Distribution": [
    { title: "Domestic Distribution Deal", description: "Negotiate the domestic distribution agreement: minimum guarantee, P&A commitment, release pattern.", durationWeeks: 12, roles: ["Sales Agent", "Producer", "Entertainment Attorney"] },
    { title: "International Territory Sales", description: "Sell distribution rights territory-by-territory to international distributors.", durationWeeks: 24, roles: ["Sales Agent", "International Sales Team"] },
    { title: "Streaming & SVOD Deals", description: "Negotiate deals with streaming platforms for post-theatrical or day-and-date digital.", durationWeeks: 12, roles: ["Sales Agent", "Distribution Executive", "Business Affairs"] },
    { title: "Delivery Requirements & Technical QC", description: "Meet each distributor's delivery specs: video masters, audio stems, subtitle/dubbing materials.", durationWeeks: 6, roles: ["Post Supervisor", "Deliverables Coordinator", "Legal"] }
  ],
  "Theatrical Release & Exhibition": [
    { title: "Release Date Selection & Competitive Analysis", description: "Choose the optimal release date analyzing the competitive landscape and marketing runway.", durationWeeks: 4, roles: ["Head of Distribution", "Marketing", "Producer"] },
    { title: "Theater Booking & Screen Count Negotiation", description: "Negotiate with theater chains for screen count, showtime placement, and film rental terms.", durationWeeks: 6, roles: ["Booker", "Exhibition Relations"] },
    { title: "Premium Format Allocation (IMAX, Dolby, PLF)", description: "Secure bookings in premium format auditoriums: IMAX, Dolby Cinema, ScreenX, 4DX.", durationWeeks: 8, roles: ["Distribution", "Premium Format Partners"] },
    { title: "DCP Manufacturing & Distribution", description: "Manufacture and ship DCPs to every theater. Manage versioning and KDM key management.", durationWeeks: 3, roles: ["Print Distribution", "Technical Operations"] },
    { title: "Advance & Preview Screenings", description: "Execute advance screenings to seed word-of-mouth: Thursday previews, fan-first events.", durationWeeks: 2, roles: ["Marketing", "Distribution", "Field Marketing"] },
    { title: "Opening Weekend Monitoring & Management", description: "Real-time monitoring of Thursday previews through Sunday. Analyze per-screen averages and demographics.", durationWeeks: 1, roles: ["Distribution Analyst", "Head of Distribution", "Marketing"] },
    { title: "Hold-Over, Expansion & Contraction Decisions", description: "Weekly analysis to determine whether to expand, hold, or contract screen count.", durationWeeks: 8, roles: ["Distribution Executive", "Booker", "Theater Chains"] },
    { title: "Exhibitor Marketing & Theater-Level Promotion", description: "Coordinate marketing support with exhibition partners: lobby standees, digital signage, loyalty programs.", durationWeeks: 6, roles: ["Exhibition Relations", "Marketing", "Promotions Department"] }
  ],
  "Post-Theatrical Windows": [
    { title: "PVOD & EST (Premium Digital)", description: "First post-theatrical window: premium video-on-demand rental and electronic sell-through purchase.", durationWeeks: 3, roles: ["Digital Distribution", "Marketing"] },
    { title: "Physical Media (Blu-ray / 4K UHD / Collector's)", description: "Author and produce physical media releases with bonus features and retail distribution.", durationWeeks: 8, roles: ["Home Entertainment", "Authoring House", "Bonus Content Producer"] },
    { title: "SVOD & Streaming Window", description: "Film becomes available on subscription streaming per negotiated deals.", durationWeeks: 2, roles: ["Digital Distribution", "Streaming Platform"] },
    { title: "Catalog Management & Long-Tail Revenue", description: "Long-term management of the film as a catalog asset: TV licensing, airline, educational distribution.", durationWeeks: 52, roles: ["Distribution", "Licensing", "Library Management"] },
    { title: "Financial Reporting & Profit Participation", description: "Prepare financial statements for all profit participants. Reconcile all revenue streams.", durationWeeks: 8, roles: ["Finance", "Accounting", "Business Affairs", "Audit"] }
  ]
};

/* ── Default Discipline definitions (structure without tasks) */
const DEFAULT_DISC_COLORS = {
  "Marketing Strategy & Planning": "#7c3aed",
  "Marketing Budget & Operations": "#475569",
  "Creative Advertising: Trailers": "#b91c1c",
  "Creative Advertising: TV Spots & Digital": "#dc2626",
  "Key Art & Visual Identity": "#9333ea",
  "Research, Tracking & Materials Testing": "#0891b2",
  "Paid Media & Media Planning": "#0369a1",
  "National PR, Publicity & Press": "#e11d48",
  "Regional PR & Field Marketing": "#f43f5e",
  "Digital & Social Media": "#0ea5e9",
  "Promotional Partnerships, Stunts & Activations": "#d946ef",
  "Festival Strategy": "#f59e0b",
  "Sales & Distribution": "#059669",
  "Theatrical Release & Exhibition": "#ea580c",
  "Post-Theatrical Windows": "#6366f1"
};

const createEmptyDisciplines = () => Object.keys(TASK_LIBRARY).map(name => ({
  id: uid(), name, color: DEFAULT_DISC_COLORS[name] || "#666", tasks: []
}));

const OTHER_PHASES = [
  { name: "Acquisition", icon: "\u{1F3AF}", taskCount: 15, description: "Script evaluation, rights/IP acquisition, deal structuring & packaging." },
  { name: "Development", icon: "\u270D\uFE0F", taskCount: 20, description: "Screenwriting, creative packaging, financing, legal clearances." },
  { name: "Pre-Production", icon: "\u{1F4CB}", taskCount: 33, description: "Production design, casting, locations, scheduling, VFX previs, camera, costumes." },
  { name: "Production", icon: "\u{1F3AC}", taskCount: 26, description: "Direction, cinematography, sound, art dept, production management, stunts." },
  { name: "Post-Production", icon: "\u{1F39E}\uFE0F", taskCount: 27, description: "Picture editing, VFX, sound design & mixing, music & score, color grading." }
];

/* ── ICONS ────────────────────────────────────────────────── */
const ChevDown = ({open, s=16}) => <svg width={s} height={s} viewBox="0 0 20 20" fill="none" style={{transform:open?"rotate(180deg)":"rotate(0)",transition:"transform .15s"}}><path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"/></svg>;

/* ── MAIN APP ─────────────────────────────────────────────── */
function App() {
  const [projectName, setProjectName] = useState("Untitled Film");
  const [releaseDate, setReleaseDate] = useState(() => defaultRelease());
  const [campaignColor, setCampaignColor] = useState("#7c3aed");
  const [disciplines, setDisciplines] = useState(() => createEmptyDisciplines());
  const [view, setView] = useState("overview");
  const [selectedDiscipline, setSelectedDiscipline] = useState(null);
  const [editingTask, setEditingTask] = useState(null);
  const [addingTaskDisc, setAddingTaskDisc] = useState(null); // {discId, discName}
  const [addingDiscipline, setAddingDiscipline] = useState(false);
  const [printMode, setPrintMode] = useState(null);

  /* ── Campaign Persistence (Firebase Cloud + localStorage fallback) */
  const fileInputRef = useRef(null);
  const [user, setUser] = useState(null);
  const [authLoading, setAuthLoading] = useState(true);
  const [campaignId, setCampaignId] = useState(null);
  const [savedCampaigns, setSavedCampaigns] = useState({});
  const [syncing, setSyncing] = useState(false);

  useEffect(() => {
    const unsub = fbAuth.onAuthStateChanged(u => { setUser(u); setAuthLoading(false); });
    return unsub;
  }, []);

  useEffect(() => {
    if (authLoading) return;
    if (!user) {
      try {
        const local = JSON.parse(localStorage.getItem('fmp-campaigns') || '{}');
        setSavedCampaigns(local);
        const lastId = localStorage.getItem('fmp-current');
        if (lastId && local[lastId] && local[lastId].disciplines) {
          const c = local[lastId];
          setProjectName(c.projectName); setReleaseDate(c.releaseDate); setDisciplines(c.disciplines);
          setCampaignColor(c.campaignColor || "#7c3aed"); setCampaignId(lastId);
        }
      } catch {}
      return;
    }
    setSyncing(true);
    fbDb.collection('users').doc(user.uid).collection('campaigns').get().then(snap => {
      const campaigns = {};
      snap.forEach(doc => { campaigns[doc.id] = doc.data(); });
      setSavedCampaigns(campaigns);
      const lastId = localStorage.getItem('fmp-current');
      if (lastId && campaigns[lastId] && campaigns[lastId].disciplines) {
        const c = campaigns[lastId];
        setProjectName(c.projectName); setReleaseDate(c.releaseDate); setDisciplines(c.disciplines);
        setCampaignColor(c.campaignColor || "#7c3aed"); setCampaignId(lastId);
      }
      setSyncing(false);
    }).catch(() => setSyncing(false));
  }, [user, authLoading]);

  useEffect(() => {
    if (!campaignId) return;
    const timer = setTimeout(() => {
      const data = { projectName, releaseDate, campaignColor, disciplines, savedAt: new Date().toISOString() };
      try { const local = JSON.parse(localStorage.getItem('fmp-campaigns') || '{}'); local[campaignId] = data; localStorage.setItem('fmp-campaigns', JSON.stringify(local)); } catch {}
      if (user) {
        setSyncing(true);
        fbDb.collection('users').doc(user.uid).collection('campaigns').doc(campaignId)
          .set(data).then(() => { setSyncing(false); setSavedCampaigns(prev => ({...prev, [campaignId]: data})); }).catch(() => setSyncing(false));
      } else {
        setSavedCampaigns(prev => ({...prev, [campaignId]: data}));
      }
    }, 2000);
    return () => clearTimeout(timer);
  }, [projectName, releaseDate, campaignColor, disciplines, campaignId, user]);

  const signIn = () => fbAuth.signInWithPopup(new firebase.auth.GoogleAuthProvider());
  const doSignOut = () => fbAuth.signOut();

  const saveCampaign = () => {
    const id = campaignId || uid();
    const data = { projectName, releaseDate, campaignColor, disciplines, savedAt: new Date().toISOString() };
    setCampaignId(id); localStorage.setItem('fmp-current', id);
    setSavedCampaigns(prev => ({...prev, [id]: data}));
    try { const local = JSON.parse(localStorage.getItem('fmp-campaigns') || '{}'); local[id] = data; localStorage.setItem('fmp-campaigns', JSON.stringify(local)); } catch {}
    if (user) { setSyncing(true); fbDb.collection('users').doc(user.uid).collection('campaigns').doc(id).set(data).then(() => setSyncing(false)).catch(() => setSyncing(false)); }
  };

  const loadCampaign = (id) => {
    const c = savedCampaigns[id]; if (!c) return;
    setProjectName(c.projectName); setReleaseDate(c.releaseDate); setDisciplines(c.disciplines);
    setCampaignColor(c.campaignColor || "#7c3aed");
    setCampaignId(id); localStorage.setItem('fmp-current', id); setEditingTask(null);
  };

  const newCampaign = () => {
    setProjectName("Untitled Film"); setReleaseDate(defaultRelease()); setCampaignColor(CAMPAIGN_COLORS[Math.floor(Math.random()*CAMPAIGN_COLORS.length)]);
    setDisciplines(createEmptyDisciplines());
    setCampaignId(null); setEditingTask(null);
  };

  const removeCampaign = (id) => {
    setSavedCampaigns(prev => { const next = {...prev}; delete next[id]; return next; });
    try { const local = JSON.parse(localStorage.getItem('fmp-campaigns') || '{}'); delete local[id]; localStorage.setItem('fmp-campaigns', JSON.stringify(local)); } catch {}
    if (user) fbDb.collection('users').doc(user.uid).collection('campaigns').doc(id).delete();
    if (campaignId === id) { setCampaignId(null); localStorage.removeItem('fmp-current'); }
  };

  const exportCampaign = () => {
    const data = { projectName, releaseDate, campaignColor, disciplines, exportedAt: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
    a.download = projectName.replace(/[^a-z0-9]+/gi,'-').toLowerCase() + '-pipeline.json'; a.click();
  };

  const importCampaign = (e) => {
    const file = e.target.files[0]; if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
      try {
        const data = JSON.parse(ev.target.result);
        if (data.projectName && data.disciplines) {
          const id = uid();
          setProjectName(data.projectName); setReleaseDate(data.releaseDate || defaultRelease());
          setDisciplines(data.disciplines); setCampaignColor(data.campaignColor || "#7c3aed");
          setCampaignId(id); localStorage.setItem('fmp-current', id);
          const saveData = {...data, savedAt: new Date().toISOString()};
          setSavedCampaigns(prev => ({...prev, [id]: saveData}));
          try { const local = JSON.parse(localStorage.getItem('fmp-campaigns') || '{}'); local[id] = saveData; localStorage.setItem('fmp-campaigns', JSON.stringify(local)); } catch {}
          if (user) fbDb.collection('users').doc(user.uid).collection('campaigns').doc(id).set(saveData);
        }
      } catch { alert("Could not read campaign file."); }
    };
    reader.readAsText(file); e.target.value = '';
  };

  const allTasks = useMemo(() => disciplines.flatMap(d => d.tasks.map(t => ({...t, disciplineName: d.name, disciplineColor: d.color}))), [disciplines]);
  const projectStart = useMemo(() => { const dates = allTasks.map(t => t.startDate).filter(Boolean).sort(); return dates[0] || releaseDate || todayStr(); }, [allTasks, releaseDate]);
  const projectEnd = useMemo(() => { const dates = allTasks.map(t => t.endDate).filter(Boolean).sort(); return dates[dates.length-1] || releaseDate || addDays(todayStr(), 180); }, [allTasks, releaseDate]);

  const updateTask = (discId, taskId, updates) => {
    setDisciplines(prev => prev.map(d => d.id === discId ? {...d, tasks: d.tasks.map(t => t.id === taskId ? {...t, ...updates} : t)} : d));
  };

  const deleteTask = (discId, taskId) => {
    setDisciplines(prev => prev.map(d => d.id === discId ? {...d, tasks: d.tasks.filter(t => t.id !== taskId)} : d));
  };

  const addTaskFromTemplate = (discId, template) => {
    const newTask = { ...template, id: uid(), status: "not-started", dependencies: [], startDate: "", endDate: "" };
    setDisciplines(prev => prev.map(d => d.id === discId ? {...d, tasks: [...d.tasks, newTask]} : d));
  };

  const addCustomTask = (discId, taskData) => {
    const newTask = { id: uid(), ...taskData, status: "not-started", dependencies: [] };
    setDisciplines(prev => prev.map(d => d.id === discId ? {...d, tasks: [...d.tasks, newTask]} : d));
  };

  const addCustomDiscipline = (name, color) => {
    setDisciplines(prev => [...prev, { id: uid(), name, color, tasks: [] }]);
  };

  const removeDiscipline = (discId) => {
    setDisciplines(prev => prev.filter(d => d.id !== discId));
  };

  const handlePrint = (mode) => {
    setPrintMode(mode);
    setTimeout(() => { window.print(); setTimeout(() => setPrintMode(null), 500); }, 200);
  };

  /* ── TASK DETAIL MODAL ──────────────────────────────────── */
  const TaskModal = ({task, discId, onClose}) => {
    const [t, setT] = useState({...task});
    const save = () => { updateTask(discId, t.id, t); onClose(); };
    return (
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000}} onClick={onClose}>
        <div style={{background:"#fff",borderRadius:12,width:560,maxHeight:"80vh",overflow:"auto",padding:28,boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}} onClick={e=>e.stopPropagation()}>
          <h3 style={{fontSize:18,fontWeight:700,marginBottom:16,color:"#1a1a2e"}}>{t.title}</h3>
          <p style={{fontSize:13,color:"#555",lineHeight:1.6,marginBottom:20}}>{t.description}</p>
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:16}}>
            <label style={{fontSize:12,fontWeight:600,color:"#666"}}>Start Date<br/><input type="date" value={t.startDate||""} onChange={e=>setT({...t,startDate:e.target.value})} style={{marginTop:4,width:"100%"}} /></label>
            <label style={{fontSize:12,fontWeight:600,color:"#666"}}>End Date<br/><input type="date" value={t.endDate||""} onChange={e=>setT({...t,endDate:e.target.value})} style={{marginTop:4,width:"100%"}} /></label>
          </div>
          <label style={{fontSize:12,fontWeight:600,color:"#666",display:"block",marginBottom:16}}>Status<br/>
            <select value={t.status} onChange={e=>setT({...t,status:e.target.value})} style={{marginTop:4,width:"100%",padding:"6px 8px"}}>
              {Object.entries(STATUS_LABELS).map(([k,v])=><option key={k} value={k}>{v}</option>)}
            </select>
          </label>
          <div style={{fontSize:12,color:"#888",marginBottom:16}}>
            <strong>Roles:</strong> {(t.roles||[]).join(", ")}<br/>
            <strong>Duration:</strong> {t.startDate && t.endDate ? daysBetween(t.startDate, t.endDate) + " days" : t.durationWeeks ? t.durationWeeks + " weeks (est.)" : "Not set"}
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"space-between"}}>
            <button onClick={()=>{if(confirm("Remove this task from the pipeline?")){deleteTask(discId,t.id);onClose();}}} style={{padding:"8px 16px",borderRadius:6,border:"1px solid #ef4444",background:"#fff",color:"#ef4444",cursor:"pointer",fontSize:13,fontWeight:600}}>Remove Task</button>
            <div style={{display:"flex",gap:8}}>
              <button onClick={onClose} style={{padding:"8px 16px",borderRadius:6,border:"1px solid #ddd",background:"#fff",cursor:"pointer",fontSize:13}}>Cancel</button>
              <button onClick={save} style={{padding:"8px 16px",borderRadius:6,border:"none",background:"#1a1a2e",color:"#fff",cursor:"pointer",fontSize:13,fontWeight:600}}>Save Changes</button>
            </div>
          </div>
        </div>
      </div>
    );
  };

  /* ── ADD TASK MODAL ─────────────────────────────────────── */
  const AddTaskModal = ({discId, discName, onClose}) => {
    const [tab, setTab] = useState("library"); // library | custom
    const [search, setSearch] = useState("");
    const [customTitle, setCustomTitle] = useState("");
    const [customDesc, setCustomDesc] = useState("");
    const [customStart, setCustomStart] = useState("");
    const [customEnd, setCustomEnd] = useState("");
    const [customRoles, setCustomRoles] = useState("");

    const templates = TASK_LIBRARY[discName] || [];
    const existingTitles = disciplines.find(d => d.id === discId)?.tasks.map(t => t.title) || [];
    const filtered = templates.filter(t => !existingTitles.includes(t.title) && (search === "" || t.title.toLowerCase().includes(search.toLowerCase())));

    const handleAddTemplate = (tmpl) => {
      addTaskFromTemplate(discId, tmpl);
    };

    const handleAddCustom = () => {
      if (!customTitle.trim()) return;
      addCustomTask(discId, {
        title: customTitle.trim(),
        description: customDesc.trim(),
        startDate: customStart,
        endDate: customEnd,
        durationWeeks: customStart && customEnd ? Math.ceil(daysBetween(customStart, customEnd) / 7) : 0,
        roles: customRoles ? customRoles.split(",").map(r => r.trim()).filter(Boolean) : []
      });
      setCustomTitle(""); setCustomDesc(""); setCustomStart(""); setCustomEnd(""); setCustomRoles("");
    };

    return (
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000}} onClick={onClose}>
        <div style={{background:"#fff",borderRadius:12,width:620,maxHeight:"85vh",overflow:"hidden",display:"flex",flexDirection:"column",boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}} onClick={e=>e.stopPropagation()}>
          <div style={{padding:"20px 24px 0"}}>
            <h3 style={{fontSize:18,fontWeight:700,color:"#1a1a2e",marginBottom:4}}>Add Task</h3>
            <p style={{fontSize:12,color:"#888",marginBottom:16}}>{discName}</p>
            <div style={{display:"flex",gap:4,marginBottom:16}}>
              <button onClick={()=>setTab("library")} style={{flex:1,padding:"8px 0",borderRadius:6,border:"none",background:tab==="library"?campaignColor+"18":"#f5f5f7",color:tab==="library"?campaignColor:"#888",fontSize:12,fontWeight:600,cursor:"pointer"}}>From Library ({filtered.length})</button>
              <button onClick={()=>setTab("custom")} style={{flex:1,padding:"8px 0",borderRadius:6,border:"none",background:tab==="custom"?campaignColor+"18":"#f5f5f7",color:tab==="custom"?campaignColor:"#888",fontSize:12,fontWeight:600,cursor:"pointer"}}>Custom Task</button>
            </div>
          </div>
          <div style={{flex:1,overflow:"auto",padding:"0 24px 20px"}}>
            {tab === "library" ? (
              <div>
                {templates.length > 0 && <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search tasks..." style={{width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:6,fontSize:12,marginBottom:12}} />}
                {filtered.length === 0 ? (
                  <div style={{textAlign:"center",padding:"30px 0",color:"#999",fontSize:13}}>
                    {templates.length === 0 ? "No library tasks for custom disciplines. Use the Custom tab." : "All library tasks already added, or no matches."}
                  </div>
                ) : filtered.map((tmpl, i) => (
                  <div key={i} style={{display:"flex",alignItems:"flex-start",gap:12,padding:"10px 12px",marginBottom:4,borderRadius:6,border:"1px solid #f0f0f0",background:"#fafafa"}}>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{fontSize:13,fontWeight:600,color:"#1a1a2e"}}>{tmpl.title}</div>
                      <div style={{fontSize:11,color:"#888",marginTop:3,lineHeight:1.5}}>{tmpl.description}</div>
                      <div style={{fontSize:10,color:"#aaa",marginTop:4}}>{tmpl.durationWeeks}w est. &middot; {tmpl.roles.join(", ")}</div>
                    </div>
                    <button onClick={()=>handleAddTemplate(tmpl)} style={{padding:"6px 14px",borderRadius:5,border:"none",background:campaignColor,color:"#fff",fontSize:11,fontWeight:600,cursor:"pointer",flexShrink:0,marginTop:2}}>+ Add</button>
                  </div>
                ))}
              </div>
            ) : (
              <div>
                <label style={{fontSize:12,fontWeight:600,color:"#666",display:"block",marginBottom:12}}>Task Title *<br/>
                  <input value={customTitle} onChange={e=>setCustomTitle(e.target.value)} placeholder="e.g., Social Media Takeover" style={{marginTop:4,width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:6,fontSize:13}} />
                </label>
                <label style={{fontSize:12,fontWeight:600,color:"#666",display:"block",marginBottom:12}}>Description<br/>
                  <textarea value={customDesc} onChange={e=>setCustomDesc(e.target.value)} rows={3} placeholder="What does this task involve?" style={{marginTop:4,width:"100%"}} />
                </label>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                  <label style={{fontSize:12,fontWeight:600,color:"#666"}}>Start Date<br/><input type="date" value={customStart} onChange={e=>setCustomStart(e.target.value)} style={{marginTop:4,width:"100%"}} /></label>
                  <label style={{fontSize:12,fontWeight:600,color:"#666"}}>End Date<br/><input type="date" value={customEnd} onChange={e=>setCustomEnd(e.target.value)} style={{marginTop:4,width:"100%"}} /></label>
                </div>
                <label style={{fontSize:12,fontWeight:600,color:"#666",display:"block",marginBottom:16}}>Roles (comma-separated)<br/>
                  <input value={customRoles} onChange={e=>setCustomRoles(e.target.value)} placeholder="e.g., Social Media Manager, Content Creator" style={{marginTop:4,width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:6,fontSize:12}} />
                </label>
                <button onClick={handleAddCustom} disabled={!customTitle.trim()} style={{width:"100%",padding:"10px 0",borderRadius:6,border:"none",background:customTitle.trim()?campaignColor:"#ddd",color:customTitle.trim()?"#fff":"#999",fontSize:13,fontWeight:600,cursor:customTitle.trim()?"pointer":"default"}}>Add Custom Task</button>
              </div>
            )}
          </div>
          <div style={{padding:"12px 24px",borderTop:"1px solid #eee",textAlign:"right"}}>
            <button onClick={onClose} style={{padding:"8px 20px",borderRadius:6,border:"1px solid #ddd",background:"#fff",cursor:"pointer",fontSize:13}}>Done</button>
          </div>
        </div>
      </div>
    );
  };

  /* ── ADD DISCIPLINE MODAL ───────────────────────────────── */
  const AddDisciplineModal = ({onClose}) => {
    const [name, setName] = useState("");
    const [color, setColor] = useState(CAMPAIGN_COLORS[Math.floor(Math.random()*CAMPAIGN_COLORS.length)]);
    const handleAdd = () => { if (!name.trim()) return; addCustomDiscipline(name.trim(), color); onClose(); };
    return (
      <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000}} onClick={onClose}>
        <div style={{background:"#fff",borderRadius:12,width:420,padding:28,boxShadow:"0 20px 60px rgba(0,0,0,0.2)"}} onClick={e=>e.stopPropagation()}>
          <h3 style={{fontSize:18,fontWeight:700,marginBottom:16,color:"#1a1a2e"}}>Add Custom Discipline</h3>
          <label style={{fontSize:12,fontWeight:600,color:"#666",display:"block",marginBottom:12}}>Discipline Name *<br/>
            <input value={name} onChange={e=>setName(e.target.value)} placeholder="e.g., Music & Soundtrack" style={{marginTop:4,width:"100%",padding:"8px 10px",border:"1px solid #d1d5db",borderRadius:6,fontSize:13}} />
          </label>
          <div style={{fontSize:12,fontWeight:600,color:"#666",marginBottom:16}}>Color
            <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:6}}>
              {CAMPAIGN_COLORS.map(c => <div key={c} onClick={()=>setColor(c)} style={{width:24,height:24,borderRadius:"50%",background:c,cursor:"pointer",border:c===color?"3px solid #1a1a2e":"3px solid transparent"}} />)}
            </div>
          </div>
          <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
            <button onClick={onClose} style={{padding:"8px 16px",borderRadius:6,border:"1px solid #ddd",background:"#fff",cursor:"pointer",fontSize:13}}>Cancel</button>
            <button onClick={handleAdd} disabled={!name.trim()} style={{padding:"8px 16px",borderRadius:6,border:"none",background:name.trim()?"#1a1a2e":"#ddd",color:name.trim()?"#fff":"#999",cursor:name.trim()?"pointer":"default",fontSize:13,fontWeight:600}}>Add Discipline</button>
          </div>
        </div>
      </div>
    );
  };

  /* ── OVERVIEW VIEW ──────────────────────────────────────── */
  const OverviewView = () => {
    const [openDiscs, setOpenDiscs] = useState({});
    const toggle = id => setOpenDiscs(p => ({...p, [id]: !p[id]}));
    const [showOther, setShowOther] = useState(false);

    /* ── Filter state ──────────────────────────────────────── */
    const [filterDisc, setFilterDisc] = useState("all");       // "all" or discipline id
    const [filterStatus, setFilterStatus] = useState("all");   // "all" | "not-started" | "in-progress" | "complete" | "blocked"
    const [searchText, setSearchText] = useState("");

    /* ── Stats (always from full unfiltered data) ──────────── */
    const totalTasks = allTasks.length;
    const notStartedTasks = allTasks.filter(t => t.status === "not-started").length;
    const inProgressTasks = allTasks.filter(t => t.status === "in-progress").length;
    const completeTasks = allTasks.filter(t => t.status === "complete").length;
    const blockedTasks = allTasks.filter(t => t.status === "blocked").length;
    const pctComplete = totalTasks > 0 ? Math.round((completeTasks / totalTasks) * 100) : 0;

    /* ── Filtering logic (AND across all active filters) ───── */
    const searchLower = searchText.trim().toLowerCase();
    const hasActiveFilter = filterDisc !== "all" || filterStatus !== "all" || searchLower.length > 0;

    const filteredDiscs = disciplines
      .filter(d => filterDisc === "all" || d.id === filterDisc)
      .map(d => {
        const filtered = d.tasks.filter(t => {
          if (filterStatus !== "all" && t.status !== filterStatus) return false;
          if (searchLower && !t.title.toLowerCase().includes(searchLower) && !(t.description || "").toLowerCase().includes(searchLower)) return false;
          return true;
        });
        return {...d, tasks: filtered, _origCount: d.tasks.length};
      });

    const filteredTaskCount = filteredDiscs.reduce((sum, d) => sum + d.tasks.length, 0);

    /* ── Disciplines that have tasks in the library ───────── */
    const discsWithTasks = disciplines.filter(d => d.tasks.length > 0);

    return (
      <div>
        {/* Stats Dashboard */}
        <div style={{display:"flex",gap:12,flexWrap:"wrap",marginBottom:20}}>
          {[
            {label:"Total Tasks", value: totalTasks, color: campaignColor},
            {label:"Not Started", value: notStartedTasks, color: STATUS_COLORS["not-started"]},
            {label:"In Progress", value: inProgressTasks, color: STATUS_COLORS["in-progress"]},
            {label:"Complete", value: completeTasks, color: STATUS_COLORS["complete"]},
            ...(blockedTasks > 0 ? [{label:"Blocked", value: blockedTasks, color: STATUS_COLORS["blocked"]}] : []),
            {label:"Progress", value: pctComplete + "%", color:"#10b981"},
            {label:"Release", value: fmt(releaseDate), color:"#ea580c"}
          ].map(s => (
            <div key={s.label} style={{background:"#fff",borderRadius:8,padding:"12px 18px",minWidth:100,borderLeft:`3px solid ${s.color}`,boxShadow:"0 1px 3px rgba(0,0,0,0.06)"}}>
              <div style={{fontSize:18,fontWeight:700,color:"#1a1a2e"}}>{s.value}</div>
              <div style={{fontSize:11,color:"#888",fontWeight:500}}>{s.label}</div>
            </div>
          ))}
        </div>

        {/* ── Filter Bar ──────────────────────────────────────── */}
        {totalTasks > 0 && (
          <div style={{background:"#fff",borderRadius:10,padding:"12px 16px",marginBottom:20,border:"1px solid #e5e7eb",boxShadow:"0 1px 3px rgba(0,0,0,0.04)"}}>
            <div style={{display:"flex",gap:12,alignItems:"center",flexWrap:"wrap"}}>
              {/* Search box */}
              <div style={{position:"relative",flex:"1 1 200px",minWidth:180}}>
                <span style={{position:"absolute",left:10,top:"50%",transform:"translateY(-50%)",fontSize:14,color:"#aaa",pointerEvents:"none"}}>&#128269;</span>
                <input
                  type="text" placeholder="Search tasks by name or description\u2026"
                  value={searchText} onChange={e=>setSearchText(e.target.value)}
                  style={{width:"100%",padding:"8px 10px 8px 32px",borderRadius:6,border:"1px solid #d1d5db",fontSize:12,outline:"none",background:"#fafafa",transition:"border .15s"}}
                />
                {searchText && (
                  <button onClick={()=>setSearchText("")} style={{position:"absolute",right:8,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"#999",fontSize:14,lineHeight:1,padding:0}}>&times;</button>
                )}
              </div>

              {/* Discipline dropdown */}
              <select
                value={filterDisc} onChange={e=>setFilterDisc(e.target.value)}
                style={{padding:"8px 10px",borderRadius:6,border:"1px solid #d1d5db",fontSize:12,background:"#fafafa",cursor:"pointer",minWidth:160}}
              >
                <option value="all">All Disciplines</option>
                {disciplines.filter(d=>d.tasks.length>0).map(d => (
                  <option key={d.id} value={d.id}>{d.name} ({d.tasks.length})</option>
                ))}
              </select>

              {/* Status filter buttons */}
              <div style={{display:"flex",gap:4}}>
                {[
                  {key:"all", label:"All"},
                  {key:"not-started", label:"Not Started", color: STATUS_COLORS["not-started"]},
                  {key:"in-progress", label:"In Progress", color: STATUS_COLORS["in-progress"]},
                  {key:"complete", label:"Complete", color: STATUS_COLORS["complete"]},
                  {key:"blocked", label:"Blocked", color: STATUS_COLORS["blocked"]}
                ].filter(s => s.key !== "blocked" || blockedTasks > 0).map(s => {
                  const active = filterStatus === s.key;
                  const col = s.color || campaignColor;
                  return (
                    <button key={s.key} onClick={()=>setFilterStatus(s.key)}
                      style={{padding:"6px 12px",borderRadius:16,border: active ? `2px solid ${col}` : "1px solid #d1d5db",
                        background: active ? col + "18" : "#fff", color: active ? col : "#888",
                        fontSize:11,fontWeight:active?700:500,cursor:"pointer",whiteSpace:"nowrap",transition:"all .15s"}}
                    >{s.label}</button>
                  );
                })}
              </div>
            </div>

            {/* Filter result count + clear */}
            {hasActiveFilter && (
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginTop:10,paddingTop:8,borderTop:"1px solid #f0f0f0"}}>
                <span style={{fontSize:12,color:"#666"}}>
                  Showing <strong style={{color:"#1a1a2e"}}>{filteredTaskCount}</strong> of {totalTasks} task{totalTasks !== 1 ? "s" : ""}
                  {filterDisc !== "all" ? ` in ${disciplines.find(d=>d.id===filterDisc)?.name || ""}` : ""}
                  {filterStatus !== "all" ? ` \u00b7 ${STATUS_LABELS[filterStatus]}` : ""}
                  {searchLower ? ` \u00b7 matching "${searchText.trim()}"` : ""}
                </span>
                <button onClick={()=>{setFilterDisc("all");setFilterStatus("all");setSearchText("");}}
                  style={{fontSize:11,color:campaignColor,background:"none",border:"none",cursor:"pointer",fontWeight:600,textDecoration:"underline"}}>Clear Filters</button>
              </div>
            )}
          </div>
        )}

        {/* Empty state */}
        {totalTasks === 0 && (
          <div style={{background:"#fff",borderRadius:12,padding:"40px 24px",textAlign:"center",marginBottom:24,border:"2px dashed #e5e7eb"}}>
            <div style={{fontSize:36,marginBottom:12}}>&#127916;</div>
            <h3 style={{fontSize:18,fontWeight:700,color:"#1a1a2e",marginBottom:8}}>Start Building Your Campaign</h3>
            <p style={{fontSize:13,color:"#888",maxWidth:440,margin:"0 auto 16px",lineHeight:1.6}}>
              Your campaign starts empty. Click the <strong>+ Add Tasks</strong> button on any discipline below to add tasks from our library of 95 industry-standard M&D tasks, or create your own custom tasks.
            </p>
          </div>
        )}

        {/* No filter results */}
        {totalTasks > 0 && hasActiveFilter && filteredTaskCount === 0 && (
          <div style={{background:"#fff",borderRadius:10,padding:"28px 24px",textAlign:"center",marginBottom:16,border:"1px solid #e5e7eb"}}>
            <div style={{fontSize:28,marginBottom:8}}>&#128270;</div>
            <div style={{fontSize:14,fontWeight:600,color:"#1a1a2e",marginBottom:4}}>No tasks match your filters</div>
            <div style={{fontSize:12,color:"#888",marginBottom:12}}>Try adjusting your search or filter criteria.</div>
            <button onClick={()=>{setFilterDisc("all");setFilterStatus("all");setSearchText("");}}
              style={{padding:"8px 20px",borderRadius:6,border:"none",background:campaignColor,color:"#fff",fontSize:12,fontWeight:600,cursor:"pointer"}}>Clear All Filters</button>
          </div>
        )}

        {/* M&D Disciplines */}
        {filteredDiscs.map(disc => {
          /* When filtering, skip disciplines with 0 matching tasks (unless no filter active) */
          if (hasActiveFilter && disc.tasks.length === 0) return null;
          const isOpen = openDiscs[disc.id] || hasActiveFilter;  /* auto-expand when filtering */
          const discNotStarted = disc.tasks.filter(t=>t.status==="not-started").length;
          const discInProgress = disc.tasks.filter(t=>t.status==="in-progress").length;
          const discComplete = disc.tasks.filter(t=>t.status==="complete").length;
          const discBlocked = disc.tasks.filter(t=>t.status==="blocked").length;
          const isLibraryDisc = !!TASK_LIBRARY[disc.name];
          const libraryCount = isLibraryDisc ? TASK_LIBRARY[disc.name].length : 0;
          return (
            <div key={disc.id} style={{marginBottom:10,border:"1px solid #e5e7eb",borderRadius:8,background:"#fff",overflow:"hidden"}}>
              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 18px",background:isOpen?"#fafafa":"#fff"}}>
                <button onClick={()=>toggle(disc.id)} style={{flex:1,display:"flex",alignItems:"center",gap:10,background:"none",border:"none",cursor:"pointer",textAlign:"left",padding:"4px 0"}}>
                  <div style={{width:4,height:32,borderRadius:2,background:disc.color}} />
                  <div>
                    <div style={{fontSize:15,fontWeight:600,color:"#1a1a2e"}}>
                      {disc.name}
                      {hasActiveFilter && disc._origCount !== disc.tasks.length ? (
                        <span style={{fontSize:11,fontWeight:400,color:"#999",marginLeft:6}}>({disc.tasks.length} of {disc._origCount})</span>
                      ) : null}
                    </div>
                    <div style={{fontSize:11,color:"#888",marginTop:2}}>
                      {disc.tasks.length > 0 ? (
                        <span>
                          <span style={{color:STATUS_COLORS["not-started"]}}>{discNotStarted} not started</span>
                          {" \u00b7 "}
                          <span style={{color:STATUS_COLORS["in-progress"]}}>{discInProgress} active</span>
                          {" \u00b7 "}
                          <span style={{color:STATUS_COLORS["complete"]}}>{discComplete} done</span>
                          {discBlocked > 0 ? <span>{" \u00b7 "}<span style={{color:STATUS_COLORS["blocked"]}}>{discBlocked} blocked</span></span> : null}
                        </span>
                      ) : (
                        <span>{isLibraryDisc ? `${libraryCount} tasks in library` : "Custom discipline"} — no tasks added yet</span>
                      )}
                    </div>
                  </div>
                </button>
                <div style={{display:"flex",gap:6,alignItems:"center"}}>
                  <button onClick={()=>setAddingTaskDisc({discId:disc.id, discName:disc.name})} style={{padding:"5px 12px",borderRadius:5,border:"none",background:campaignColor+"15",color:campaignColor,fontSize:11,fontWeight:600,cursor:"pointer"}}>+ Add Tasks</button>
                  {!isLibraryDisc && disc._origCount === 0 && (
                    <button onClick={()=>{if(confirm('Remove "'+disc.name+'" discipline?'))removeDiscipline(disc.id);}} style={{padding:"5px 8px",borderRadius:5,border:"none",background:"#fef2f2",color:"#ef4444",fontSize:11,cursor:"pointer"}}>&times;</button>
                  )}
                  <ChevDown open={isOpen} />
                </div>
              </div>
              {isOpen && (
                <div style={{padding:"4px 16px 16px"}}>
                  {disc.tasks.length === 0 ? (
                    <div style={{textAlign:"center",padding:"20px 0",color:"#bbb",fontSize:13}}>
                      No tasks yet. Click <strong>+ Add Tasks</strong> to get started.
                    </div>
                  ) : disc.tasks.map(task => (
                    <div key={task.id} onClick={()=>setEditingTask({task, discId: disc.id})} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 12px",marginBottom:4,borderRadius:6,cursor:"pointer",background:"#fafafa",border:"1px solid #f0f0f0",transition:"background .1s"}}>
                      <div style={{width:8,height:8,borderRadius:"50%",background:STATUS_COLORS[task.status],flexShrink:0}} />
                      <div style={{flex:1,minWidth:0}}>
                        <div style={{fontSize:13,fontWeight:500,color:"#1a1a2e"}}>{task.title}</div>
                        <div style={{fontSize:11,color:"#999",marginTop:2}}>
                          {task.startDate && task.endDate ? `${fmt(task.startDate)} \u2013 ${fmt(task.endDate)} \u00b7 ` : ""}
                          {STATUS_LABELS[task.status]}
                        </div>
                      </div>
                      <div style={{fontSize:11,color:disc.color,fontWeight:600,flexShrink:0}}>{task.startDate && task.endDate ? daysBetween(task.startDate, task.endDate) + "d" : ""}</div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          );
        })}

        {/* Add Custom Discipline */}
        {!hasActiveFilter && (
          <button onClick={()=>setAddingDiscipline(true)} style={{width:"100%",padding:"14px 0",borderRadius:8,border:"2px dashed #d1d5db",background:"transparent",color:"#888",fontSize:13,fontWeight:600,cursor:"pointer",marginBottom:24}}>
            + Add Custom Discipline
          </button>
        )}

        {/* Other Phases Reference */}
        {!hasActiveFilter && (
          <div style={{marginTop:16}}>
            <button onClick={()=>setShowOther(!showOther)} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 0",background:"none",border:"none",cursor:"pointer",fontSize:14,fontWeight:600,color:"#888"}}>
              <ChevDown open={showOther} s={14} /> Other Pipeline Phases (Reference)
            </button>
            {showOther && (
              <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(280px,1fr))",gap:10,marginTop:8}}>
                {OTHER_PHASES.map(p => (
                  <div key={p.name} style={{background:"#fff",borderRadius:8,padding:"14px 16px",border:"1px solid #e5e7eb"}}>
                    <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:6}}>
                      <span style={{fontSize:20}}>{p.icon}</span>
                      <span style={{fontSize:14,fontWeight:600,color:"#1a1a2e"}}>{p.name}</span>
                      <span style={{fontSize:11,color:"#999",marginLeft:"auto"}}>{p.taskCount} tasks</span>
                    </div>
                    <div style={{fontSize:12,color:"#666",lineHeight:1.5}}>{p.description}</div>
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </div>
    );
  };

  /* ── GANTT VIEW ─────────────────────────────────────────── */
  const GanttView = () => {
    const tasksWithDates = allTasks.filter(t => t.startDate && t.endDate);
    if (tasksWithDates.length === 0) {
      return (
        <div style={{background:"#fff",borderRadius:12,padding:"60px 24px",textAlign:"center",border:"1px solid #e5e7eb"}}>
          <div style={{fontSize:36,marginBottom:12}}>&#128197;</div>
          <h3 style={{fontSize:18,fontWeight:700,color:"#1a1a2e",marginBottom:8}}>No Tasks Scheduled Yet</h3>
          <p style={{fontSize:13,color:"#888"}}>Add tasks and set their dates to see the timeline view.</p>
        </div>
      );
    }
    const totalDays = daysBetween(projectStart, projectEnd) + 14;
    const months = [];
    let cursor = getMonthStart(projectStart);
    const end = addDays(projectEnd, 14);
    while (cursor <= end) { months.push(cursor); const d = new Date(cursor + "T00:00:00"); d.setMonth(d.getMonth() + 1); cursor = d.toISOString().slice(0, 10); }
    const dayWidth = 3;
    const rowH = 28;
    const headerH = 44;
    const labelW = 220;
    const getX = date => { if (!date) return 0; return daysBetween(projectStart, date) * dayWidth; };
    const relX = getX(releaseDate);
    const discsWithTasks = disciplines.filter(d => d.tasks.some(t => t.startDate && t.endDate));

    return (
      <div className="gantt-scroll" style={{overflow:"auto",background:"#fff",borderRadius:8,border:"1px solid #e5e7eb"}}>
        <div style={{display:"flex",minWidth: labelW + totalDays * dayWidth}}>
          <div style={{width:labelW,minWidth:labelW,borderRight:"1px solid #e5e7eb",background:"#fafafa",position:"sticky",left:0,zIndex:10}}>
            <div style={{height:headerH,borderBottom:"1px solid #e5e7eb",padding:"0 12px",display:"flex",alignItems:"center",fontSize:11,fontWeight:700,color:"#888",textTransform:"uppercase",letterSpacing:"0.05em"}}>Task</div>
            {discsWithTasks.map(disc => (
              <React.Fragment key={disc.id}>
                <div style={{height:rowH,background:disc.color+"11",padding:"0 12px",display:"flex",alignItems:"center",fontSize:12,fontWeight:700,color:disc.color,borderBottom:"1px solid #f0f0f0"}}>{disc.name}</div>
                {disc.tasks.filter(t=>t.startDate&&t.endDate).map(task => (
                  <div key={task.id} onClick={()=>setEditingTask({task, discId:disc.id})} style={{height:rowH,padding:"0 12px",display:"flex",alignItems:"center",fontSize:11,color:"#555",borderBottom:"1px solid #f8f8f8",cursor:"pointer",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}} title={task.title}>{task.title}</div>
                ))}
              </React.Fragment>
            ))}
          </div>
          <div style={{flex:1,position:"relative"}}>
            <div style={{height:headerH,display:"flex",borderBottom:"1px solid #e5e7eb",position:"sticky",top:0,background:"#fff",zIndex:5}}>
              {months.map(m => { const x = getX(m); const nextMonth = new Date(m + "T00:00:00"); nextMonth.setMonth(nextMonth.getMonth() + 1); const w = daysBetween(m, nextMonth.toISOString().slice(0,10)) * dayWidth; return <div key={m} style={{position:"absolute",left:x,width:w,height:headerH,borderRight:"1px solid #f0f0f0",display:"flex",alignItems:"center",justifyContent:"center",fontSize:11,fontWeight:600,color:"#888"}}>{monthLabel(m)}</div>; })}
            </div>
            {discsWithTasks.map(disc => (
              <React.Fragment key={disc.id}>
                <div style={{height:rowH,background:disc.color+"08",borderBottom:"1px solid #f0f0f0"}} />
                {disc.tasks.filter(t=>t.startDate&&t.endDate).map(task => (
                  <div key={task.id} style={{height:rowH,position:"relative",borderBottom:"1px solid #f8f8f8"}}>
                    <div onClick={()=>setEditingTask({task, discId:disc.id})} style={{position:"absolute",left:getX(task.startDate),width:Math.max(daysBetween(task.startDate, task.endDate) * dayWidth, 6),height:18,top:5,borderRadius:4,background:STATUS_COLORS[task.status],borderLeft:`4px solid ${campaignColor}`,opacity:0.85,cursor:"pointer"}} title={`${task.title}: ${fmt(task.startDate)} \u2013 ${fmt(task.endDate)}`} />
                  </div>
                ))}
              </React.Fragment>
            ))}
            <div style={{position:"absolute",left:relX,top:0,bottom:0,width:2,background:"#ef4444",zIndex:8,pointerEvents:"none"}}>
              <div style={{position:"absolute",top:2,left:-28,background:"#ef4444",color:"#fff",fontSize:9,padding:"2px 6px",borderRadius:3,fontWeight:700,whiteSpace:"nowrap"}}>RELEASE</div>
            </div>
            {(() => { const today = new Date().toISOString().slice(0,10); if (today >= projectStart && today <= projectEnd) { return <div style={{position:"absolute",left:getX(today),top:0,bottom:0,width:1,background:"#3b82f6",zIndex:7,pointerEvents:"none",borderLeft:"1px dashed #3b82f6"}} />; } return null; })()}
          </div>
        </div>
      </div>
    );
  };

  /* ── CALENDAR VIEW ──────────────────────────────────────── */
  const CalendarView = () => {
    const [currentMonth, setCurrentMonth] = useState(() => { const d = new Date(); return d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0"); });
    const year = parseInt(currentMonth.split("-")[0]);
    const month = parseInt(currentMonth.split("-")[1]) - 1;
    const firstDay = new Date(year, month, 1).getDay();
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    const prevMonth = () => { const d = new Date(year, month - 1, 1); setCurrentMonth(d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0")); };
    const nextMonth = () => { const d = new Date(year, month + 1, 1); setCurrentMonth(d.getFullYear() + "-" + String(d.getMonth()+1).padStart(2,"0")); };
    const monthStr = new Date(year, month, 1).toLocaleDateString("en-US", {month:"long", year:"numeric"});

    const getTasksForDay = (day) => {
      const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      return allTasks.filter(t => t.startDate && t.endDate && dateStr >= t.startDate && dateStr <= t.endDate);
    };

    const cells = [];
    for (let i = 0; i < firstDay; i++) cells.push(<div key={`e${i}`} style={{background:"#fafafa",borderRadius:4,minHeight:80}} />);
    for (let day = 1; day <= daysInMonth; day++) {
      const dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(day).padStart(2,"0")}`;
      const tasks = getTasksForDay(day);
      const isToday = dateStr === new Date().toISOString().slice(0,10);
      const isRelease = dateStr === releaseDate;
      cells.push(
        <div key={day} style={{background:isRelease?"#fef2f2":isToday?"#eff6ff":"#fff",borderRadius:4,padding:"4px 6px",minHeight:80,border:isRelease?"2px solid #ef4444":isToday?"2px solid #3b82f6":"1px solid #eee",overflow:"hidden"}}>
          <div style={{fontSize:12,fontWeight:isToday||isRelease?700:500,color:isRelease?"#ef4444":isToday?"#3b82f6":"#555",marginBottom:4}}>{day}{isRelease ? " \u{1F3AC}" : ""}</div>
          {tasks.slice(0, 3).map(t => (
            <div key={t.id} onClick={()=>{ const disc = disciplines.find(d=>d.tasks.some(tk=>tk.id===t.id)); if(disc) setEditingTask({task:t,discId:disc.id}); }} style={{fontSize:9,padding:"2px 4px",marginBottom:2,borderRadius:3,background:campaignColor+"18",color:campaignColor,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",borderLeft:`2px solid ${campaignColor}`}} title={t.title}>{t.title}</div>
          ))}
          {tasks.length > 3 && <div style={{fontSize:9,color:"#999"}}>+{tasks.length-3} more</div>}
        </div>
      );
    }

    return (
      <div style={{background:"#fff",borderRadius:8,border:"1px solid #e5e7eb",padding:20}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:16}}>
          <button onClick={prevMonth} style={{padding:"6px 12px",borderRadius:6,border:"1px solid #ddd",background:"#fff",cursor:"pointer",fontSize:14}}>&larr;</button>
          <h3 style={{fontSize:16,fontWeight:700,color:"#1a1a2e"}}>{monthStr}</h3>
          <button onClick={nextMonth} style={{padding:"6px 12px",borderRadius:6,border:"1px solid #ddd",background:"#fff",cursor:"pointer",fontSize:14}}>&rarr;</button>
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4,marginBottom:4}}>
          {["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map(d=><div key={d} style={{fontSize:11,fontWeight:700,color:"#999",textAlign:"center",padding:"4px 0"}}>{d}</div>)}
        </div>
        <div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:4}}>{cells}</div>
        {disciplines.filter(d=>d.tasks.length>0).length > 0 && (
          <div style={{marginTop:12,display:"flex",flexWrap:"wrap",gap:8}}>
            {disciplines.filter(d=>d.tasks.length>0).map(d => <span key={d.id} style={{fontSize:10,padding:"3px 8px",borderRadius:10,background:d.color+"18",color:d.color,fontWeight:600}}>{d.name}</span>)}
          </div>
        )}
      </div>
    );
  };

  /* ── PRINT VIEWS ────────────────────────────────────────── */
  if (printMode === "overview") {
    return (
      <div style={{padding:40,maxWidth:900,margin:"0 auto"}}>
        <div style={{display:"flex",alignItems:"center",gap:16,paddingBottom:20,borderBottom:`3px solid ${campaignColor}`,marginBottom:28}}>
          <div style={{width:8,height:40,borderRadius:4,background:campaignColor}} />
          <div>
            <h1 style={{fontSize:28,fontWeight:800,color:"#1a1a2e",margin:0}}>{projectName}</h1>
            <p style={{fontSize:14,color:"#666",margin:"4px 0 0"}}>Marketing & Distribution Pipeline &middot; Release: {fmt(releaseDate)}</p>
          </div>
        </div>
        {disciplines.filter(d=>d.tasks.length>0).map(disc => (
          <div key={disc.id} style={{marginBottom:28,pageBreakInside:"avoid"}}>
            <h2 style={{fontSize:16,fontWeight:700,color:disc.color,margin:"0 0 10px",paddingBottom:6,borderBottom:`2px solid ${disc.color}33`}}>{disc.name}</h2>
            <table style={{width:"100%",borderCollapse:"collapse",fontSize:12}}>
              <thead><tr style={{background:"#f5f5f7"}}>
                <th style={{textAlign:"left",padding:"6px 10px",fontWeight:700,color:"#555",borderBottom:"1px solid #ddd"}}>Task</th>
                <th style={{textAlign:"left",padding:"6px 10px",fontWeight:700,color:"#555",borderBottom:"1px solid #ddd",width:90}}>Start</th>
                <th style={{textAlign:"left",padding:"6px 10px",fontWeight:700,color:"#555",borderBottom:"1px solid #ddd",width:90}}>End</th>
                <th style={{textAlign:"left",padding:"6px 10px",fontWeight:700,color:"#555",borderBottom:"1px solid #ddd",width:80}}>Status</th>
              </tr></thead>
              <tbody>
                {disc.tasks.map(t => (
                  <tr key={t.id}>
                    <td style={{padding:"5px 10px",borderBottom:"1px solid #eee",fontWeight:500}}>{t.title}</td>
                    <td style={{padding:"5px 10px",borderBottom:"1px solid #eee",fontSize:11,color:"#666"}}>{fmt(t.startDate)}</td>
                    <td style={{padding:"5px 10px",borderBottom:"1px solid #eee",fontSize:11,color:"#666"}}>{fmt(t.endDate)}</td>
                    <td style={{padding:"5px 10px",borderBottom:"1px solid #eee"}}><span style={{fontSize:10,padding:"2px 6px",borderRadius:3,background:STATUS_COLORS[t.status]+"22",color:STATUS_COLORS[t.status],fontWeight:700}}>{STATUS_LABELS[t.status]}</span></td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        ))}
        <div style={{marginTop:40,paddingTop:16,borderTop:"1px solid #ddd",fontSize:10,color:"#aaa",textAlign:"center"}}>Generated {new Date().toLocaleDateString()} &middot; Film Marketing & Distribution Pipeline</div>
      </div>
    );
  }

  if (printMode === "timeline") {
    const tasksWithDates = allTasks.filter(t => t.startDate && t.endDate);
    if (tasksWithDates.length === 0) return <div style={{padding:40,textAlign:"center",color:"#999"}}>No scheduled tasks to print.</div>;
    const totalDays = daysBetween(projectStart, projectEnd) + 14;
    const dayWidth = 2;
    const months = [];
    let cursor = getMonthStart(projectStart);
    const end = addDays(projectEnd, 14);
    while (cursor <= end) { months.push(cursor); const d = new Date(cursor + "T00:00:00"); d.setMonth(d.getMonth() + 1); cursor = d.toISOString().slice(0, 10); }
    const getX = date => daysBetween(projectStart, date) * dayWidth;
    const discsWithTasks = disciplines.filter(d => d.tasks.some(t => t.startDate && t.endDate));
    return (
      <div style={{padding:"30px 20px"}}>
        <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
          <div style={{width:6,height:30,borderRadius:3,background:campaignColor}} />
          <div>
            <h1 style={{fontSize:22,fontWeight:800,color:"#1a1a2e",margin:0}}>{projectName} &mdash; Timeline</h1>
            <p style={{fontSize:12,color:"#888",margin:"2px 0 0"}}>Release: {fmt(releaseDate)} &middot; {allTasks.length} tasks across {disciplines.length} disciplines</p>
          </div>
        </div>
        <div style={{overflowX:"auto"}}>
          <div style={{minWidth:200 + totalDays * dayWidth}}>
            <div style={{display:"flex",marginLeft:200,height:24,borderBottom:"1px solid #ddd"}}>
              {months.map(m => { const d2=new Date(m+"T00:00:00"); d2.setMonth(d2.getMonth()+1); const w=daysBetween(m,d2.toISOString().slice(0,10))*dayWidth; return <div key={m} style={{position:"absolute",marginLeft:getX(m),width:w,fontSize:9,fontWeight:700,color:"#888",textAlign:"center"}}>{monthLabel(m)}</div>; })}
            </div>
            {discsWithTasks.map(disc => (
              <div key={disc.id} style={{marginBottom:12}}>
                <div style={{fontSize:10,fontWeight:800,color:disc.color,padding:"4px 0",marginBottom:2}}>{disc.name}</div>
                {disc.tasks.filter(t=>t.startDate&&t.endDate).map(t => (
                  <div key={t.id} style={{display:"flex",alignItems:"center",height:18,marginBottom:2}}>
                    <div style={{width:200,minWidth:200,fontSize:8,color:"#555",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis",paddingRight:8}}>{t.title}</div>
                    <div style={{position:"relative",flex:1,height:12}}>
                      <div style={{position:"absolute",left:getX(t.startDate),width:Math.max(daysBetween(t.startDate,t.endDate)*dayWidth,4),height:12,borderRadius:2,background:STATUS_COLORS[t.status],opacity:0.8}} />
                    </div>
                  </div>
                ))}
              </div>
            ))}
          </div>
        </div>
        <div style={{marginTop:20,fontSize:9,color:"#aaa",textAlign:"center"}}>Generated {new Date().toLocaleDateString()}</div>
      </div>
    );
  }

  /* ── MAIN LAYOUT ────────────────────────────────────────── */
  return (
    <div style={{display:"flex",height:"100vh",background:"#f5f5f7"}}>
      {/* Sidebar */}
      <div className="sidebar-container no-print" style={{width:240,minWidth:240,background:"#1a1a2e",color:"#fff",display:"flex",flexDirection:"column",overflow:"auto"}}>
        {/* Campaign Management */}
        <div style={{padding:"10px 12px",borderBottom:"1px solid rgba(255,255,255,0.08)"}}>
          <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:6}}>
            <div style={{fontSize:10,fontWeight:700,color:"#8888aa",textTransform:"uppercase",letterSpacing:"0.05em"}}>Campaigns</div>
            <div style={{fontSize:9,fontWeight:600,color:syncing?"#f59e0b":campaignId?"#10b981":"#8888aa"}}>
              {syncing ? "\u25CF Syncing..." : campaignId ? (user ? "\u25CF Cloud" : "\u25CF Local") : ""}
            </div>
          </div>
          {authLoading ? (
            <div style={{fontSize:10,color:"#666",padding:"4px 0"}}>Loading...</div>
          ) : !user ? (
            <button onClick={signIn} style={{width:"100%",padding:"7px 0",borderRadius:5,border:"none",background:"#4285f4",color:"#fff",fontSize:11,cursor:"pointer",fontWeight:600,marginBottom:6}}>Sign in with Google</button>
          ) : (
            <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:6,padding:"2px 0"}}>
              {user.photoURL && <img src={user.photoURL} style={{width:16,height:16,borderRadius:"50%"}} referrerPolicy="no-referrer" />}
              <div style={{flex:1,fontSize:9,color:"#aaa",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user.email}</div>
              <button onClick={doSignOut} style={{fontSize:9,color:"#666",background:"none",border:"none",cursor:"pointer",textDecoration:"underline",flexShrink:0}}>out</button>
            </div>
          )}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:3,marginBottom:6}}>
            <button onClick={saveCampaign} style={{padding:"5px 0",borderRadius:4,border:"none",background:!campaignId?"#10b981":"rgba(255,255,255,0.08)",color:!campaignId?"#fff":"#ccc",fontSize:10,cursor:"pointer",fontWeight:600}}>{campaignId?"Save":"Save Campaign"}</button>
            <button onClick={newCampaign} style={{padding:"5px 0",borderRadius:4,border:"none",background:"rgba(255,255,255,0.08)",color:"#ccc",fontSize:10,cursor:"pointer"}}>New Campaign</button>
            <button onClick={exportCampaign} style={{padding:"5px 0",borderRadius:4,border:"none",background:"rgba(255,255,255,0.08)",color:"#ccc",fontSize:10,cursor:"pointer"}}>Export JSON</button>
            <button onClick={()=>fileInputRef.current?.click()} style={{padding:"5px 0",borderRadius:4,border:"none",background:"rgba(255,255,255,0.08)",color:"#ccc",fontSize:10,cursor:"pointer"}}>Import JSON</button>
          </div>
          {Object.keys(savedCampaigns).length > 0 && (
            <div style={{maxHeight:120,overflow:"auto"}}>
              <div style={{fontSize:9,color:"#666",marginBottom:3,textTransform:"uppercase",letterSpacing:"0.04em"}}>Saved</div>
              {Object.entries(savedCampaigns).map(([id, c]) => (
                <div key={id} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 6px",marginBottom:2,borderRadius:4,background:id===campaignId?"rgba(255,255,255,0.12)":"transparent",cursor:"pointer",borderLeft:`3px solid ${c.campaignColor||"#7c3aed"}`,transition:"background .1s"}} onClick={()=>loadCampaign(id)}>
                  <div style={{width:8,height:8,borderRadius:"50%",background:c.campaignColor||"#7c3aed",flexShrink:0}} />
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:10,color:id===campaignId?"#fff":"#aaa",fontWeight:id===campaignId?600:400,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{c.projectName||"Untitled"}</div>
                    <div style={{fontSize:8,color:"#555"}}>{c.savedAt ? new Date(c.savedAt).toLocaleDateString("en-US",{month:"short",day:"numeric"}) : ""} &middot; {c.disciplines ? c.disciplines.reduce((a,d)=>a+d.tasks.length,0) : 0} tasks</div>
                  </div>
                  <button onClick={(e)=>{e.stopPropagation();if(confirm('Delete "'+c.projectName+'"?'))removeCampaign(id);}} style={{background:"none",border:"none",color:"#ef4444",fontSize:14,cursor:"pointer",padding:"0 2px",lineHeight:1,flexShrink:0}}>&times;</button>
                </div>
              ))}
            </div>
          )}
          <input ref={fileInputRef} type="file" accept=".json" onChange={importCampaign} style={{display:"none"}} />
        </div>

        <div style={{padding:"14px 14px 10px"}}>
          {/* Campaign color bar */}
          <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
            <div style={{width:6,height:28,borderRadius:3,background:campaignColor}} />
            <input value={projectName} onChange={e=>setProjectName(e.target.value)} style={{background:"transparent",border:"none",color:"#fff",fontSize:14,fontWeight:700,width:"100%",outline:"none"}} />
          </div>
          {/* Campaign color picker */}
          <div style={{marginBottom:10}}>
            <div style={{fontSize:10,color:"#8888aa",marginBottom:4}}>Campaign Color</div>
            <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>
              {CAMPAIGN_COLORS.map(c => <div key={c} onClick={()=>setCampaignColor(c)} style={{width:18,height:18,borderRadius:"50%",background:c,cursor:"pointer",border:c===campaignColor?"2px solid #fff":"2px solid transparent",transition:"border .1s"}} />)}
            </div>
          </div>
          <div>
            <label style={{fontSize:10,color:"#8888aa"}}>Release Date</label>
            <input type="date" value={releaseDate} onChange={e=>setReleaseDate(e.target.value)} style={{display:"block",marginTop:3,width:"100%",background:"rgba(255,255,255,0.08)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:4,color:"#fff",padding:"4px 6px",fontSize:11}} />
          </div>
        </div>

        {/* View tabs */}
        <div style={{padding:"8px 10px",display:"flex",gap:4}}>
          {[["overview","Overview"],["gantt","Timeline"],["calendar","Calendar"]].map(([v,l])=>(
            <button key={v} onClick={()=>setView(v)} style={{flex:1,padding:"6px 0",borderRadius:5,border:"none",background:view===v?campaignColor+"33":"transparent",color:view===v?"#fff":"#8888aa",fontSize:11,fontWeight:600,cursor:"pointer"}}>{l}</button>
          ))}
        </div>

        {/* Discipline nav */}
        <nav style={{flex:1,padding:"4px 8px"}}>
          <div style={{fontSize:10,fontWeight:700,color:"#8888aa",textTransform:"uppercase",letterSpacing:"0.05em",padding:"8px 8px 4px"}}>Disciplines</div>
          {disciplines.map(d => {
            const done = d.tasks.filter(t=>t.status==="complete").length;
            const total = d.tasks.length;
            return (
              <button key={d.id} onClick={()=>setSelectedDiscipline(d.id===selectedDiscipline?null:d.id)} style={{width:"100%",display:"flex",alignItems:"center",gap:8,padding:"7px 8px",background:selectedDiscipline===d.id?"rgba(255,255,255,0.08)":"transparent",border:"none",borderRadius:6,cursor:"pointer",textAlign:"left",color:selectedDiscipline===d.id?"#fff":"#aaa",marginBottom:1}}>
                <div style={{width:3,height:20,borderRadius:2,background:d.color}} />
                <div style={{flex:1,minWidth:0}}>
                  <div style={{fontSize:12,fontWeight:500,whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{d.name}</div>
                  <div style={{fontSize:10,color:"#666",marginTop:1}}>{total > 0 ? `${done}/${total} \u00b7 ${Math.round(done/total*100)}%` : "No tasks"}</div>
                </div>
              </button>
            );
          })}
        </nav>

        {/* Print buttons */}
        <div style={{padding:"10px 12px",borderTop:"1px solid rgba(255,255,255,0.08)"}}>
          <div style={{fontSize:10,fontWeight:700,color:"#8888aa",textTransform:"uppercase",letterSpacing:"0.05em",marginBottom:6}}>Export PDF</div>
          <button onClick={()=>handlePrint("overview")} style={{width:"100%",padding:"7px 0",borderRadius:5,border:"1px solid rgba(255,255,255,0.15)",background:"transparent",color:"#ccc",fontSize:11,cursor:"pointer",marginBottom:4}}>Project Overview</button>
          <button onClick={()=>handlePrint("timeline")} style={{width:"100%",padding:"7px 0",borderRadius:5,border:"1px solid rgba(255,255,255,0.15)",background:"transparent",color:"#ccc",fontSize:11,cursor:"pointer"}}>Timeline Export</button>
        </div>
      </div>

      {/* Main */}
      <div className="main-scroll" style={{flex:1,overflow:"auto",padding:24}}>
        {/* Campaign header accent */}
        <div style={{height:4,background:campaignColor,borderRadius:2,marginBottom:20,maxWidth:view==="gantt"?undefined:960,margin:view==="gantt"?"0 0 20px":undefined}} />
        <div style={{maxWidth:view==="gantt"?undefined:960,margin:view==="gantt"?undefined:"0 auto"}}>
          {view === "overview" && <OverviewView />}
          {view === "gantt" && <GanttView />}
          {view === "calendar" && <CalendarView />}
        </div>
      </div>

      {/* Modals */}
      {editingTask && <TaskModal task={editingTask.task} discId={editingTask.discId} onClose={()=>setEditingTask(null)} />}
      {addingTaskDisc && <AddTaskModal discId={addingTaskDisc.discId} discName={addingTaskDisc.discName} onClose={()=>setAddingTaskDisc(null)} />}
      {addingDiscipline && <AddDisciplineModal onClose={()=>setAddingDiscipline(false)} />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
